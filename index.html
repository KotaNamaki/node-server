<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Tester (Session-Based)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        section {
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-basis: 300px;
            flex-grow: 1;
        }
        h2 {
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            color: #333;
        }
        fieldset {
            margin-bottom: 12px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
        }
        legend {
            font-weight: bold;
            color: #555;
            padding: 0 5px;
        }
        input, select, button {
            width: 100%;
            margin-bottom: 8px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button.delete { background-color: #dc3545; }
        button.delete:hover { background-color: #c82333; }
        button.update { background-color: #ffc107; color: #212529; }
        button.update:hover { background-color: #e0a800; }
        #response-output {
            white-space: pre-wrap;
            background-color: #282c34;
            color: #abb2bf;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 6px;
            min-height: 300px;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
        }
        #user-info {
            background: #fff8e1;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ffe58f;
            white-space: pre-wrap;
            font-family: "Courier New", Courier, monospace;
            font-size: 13px;
            color: #66562b;
        }
    </style>
</head>
<body>

<!-- KOLOM 1: AUTENTIKASI & INFO -->
<section>
    <h2>1. Auth & Info</h2>

    <fieldset>
        <legend>Register</legend>
        <input type="email" id="reg-email" placeholder="Email (cth: user@mail.com)">
        <input type="text" id="reg-nama" placeholder="Nama (cth: User Biasa)">
        <input type="text" id="reg-hp" placeholder="No HP (cth: 08123)">
        <input type="password" id="reg-pass" placeholder="Password">
        <select id="reg-role">
            <option value="customer">Customer</option>
            <option value="admin">Admin</option>
        </select>
        <button id="btn-register">Register</button>
    </fieldset>

    <fieldset>
        <legend>Login</legend>
        <input type="email" id="login-email" placeholder="Email (user@mail.com)">
        <input type="password" id="login-pass" placeholder="Password">
        <button id="btn-login">Login (Dapat Cookie)</button>
    </fieldset>

    <!-- BARU: Tombol Logout -->
    <fieldset>
        <legend>Logout (Perlu Login)</legend>
        <button id="btn-logout" class="delete">Logout</button>
    </fieldset>

    <fieldset>
        <legend>User Info (Setelah Login)</legend>
        <pre id="user-info">Login untuk melihat info...</pre>
    </fieldset>
</section>

<!-- KOLOM 2: CUSTOMER -->
<section>
    <h2>2. Alur Customer</h2>

    <fieldset>
        <legend>Products (Publik)</legend>
        <button id="btn-get-products">Get All Products</button>
        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
        <input type="number" id="prod-id" placeholder="ID Produk (cth: 1)">
        <button id="btn-get-product-by-id">Get Product by ID</button>
    </fieldset>

    <fieldset>
        <legend>Cart (Perlu Login)</legend>
        <input type="number" id="cart-prod-id" placeholder="ID Produk (cth: 1)">
        <input type="number" id="cart-qty" placeholder="Qty (cth: 2)" value="1">
        <button id="btn-add-cart">Add to Cart</button>
        <button id="btn-cart-update" class="update">Update Qty</button>
        <button id="btn-cart-delete" class="delete">Delete Item</button>
        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
        <button id="btn-get-cart">Get Cart</button>
    </fieldset>

    <fieldset>
        <legend>Orders (Perlu Login)</legend>
        <button id="btn-checkout">Create Order (Checkout)</button>
        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
        <input type="number" id="order-id" placeholder="ID Pesanan (dari checkout)">
        <button id="btn-get-order-detail">Get Order Detail</button>
        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
        <select id="pay-method">
            <option value="">-- Pilih Metode --</option>
            <option value="MOBILE_BANKING">MOBILE BANKING</option>
            <option value="DANA">DANA</option>
            <option value="QRIS">QRIS</option>
            <option value="VA">VA</option>
        </select>
        <input type="number" id="pay-amount" placeholder="Amount (cth: 50000)">
        <button id="btn-add-payment">Add Payment</button>
    </fieldset>
</section>

<!-- KOLOM 3: ADMIN & USER -->
<section>
    <h2>3. Admin & User Actions</h2>
    <fieldset>
        <legend>Admin Panel (Perlu Token Admin)</legend>
        <input type="text" id="admin-prod-nama" placeholder="Nama Produk">
        <input type="text" id="admin-prod-kategori" placeholder="Kategori">
        <input type="text" id="admin-prod-desk" placeholder="Deskripsi">
        <input type="number" id="admin-prod-harga" placeholder="Harga">
        <input type="number" id="admin-prod-stok" placeholder="Stok">
        <button id="btn-admin-add-prod">Add Product</button>
        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
        <input type="number" id="admin-prod-id" placeholder="ID Produk (utk Update/Delete)">
        <button id="btn-admin-update-prod" class="update">Update Product</button>
        <button id="btn-admin-delete-prod" class="delete">Delete Product</button>
    </fieldset>

    <fieldset>
        <legend>User Panel (Perlu Login)</legend>
        <button id="btn-user-get-all">Get All Users</button>
        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
        <input type="number" id="user-id" placeholder="User ID (cth: 1)">
        <button id="btn-user-get">Get User by ID</button>
        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
        <input type="text" id="user-nama" placeholder="Nama Baru">
        <input type="text" id="user-email" placeholder="Email Baru">
        <button id="btn-user-update" class="update">Update User</button>
    </fieldset>
</section>

<!-- KOLOM 4: RESPONSE -->
<section style="flex-grow: 2; flex-basis: 400px;">
    <h2>Server Response</h2>
    <pre id="response-output">...</pre>
</section>

<script>
    // --- Konfigurasi ---
    const baseUrl = 'http://localhost:3000/api'; // Pastikan ini alamat server Anda
    // 'null' untuk tes dari file lokal
    // Ganti 'http://127.0.0.1:5500' jika pakai Live Server
    const clientUrl = 'null';

    // --- Elemen DOM ---
    const output = document.getElementById('response-output');
    const userInfoEl = document.getElementById('user-info');

    // --- Helper ---
    const showResponse = (data) => {
        output.textContent = JSON.stringify(data, null, 2);
    };

    // DIUBAH: Tidak perlu kirim token, hanya Content-Type
    const getHeaders = () => {
        return { 'Content-Type': 'application/json' };
    };

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. AUTH ---
        document.getElementById('btn-register').onclick = async () => {
            const body = {
                email: document.getElementById('reg-email').value,
                nama: document.getElementById('reg-nama').value,
                no_hp: document.getElementById('reg-hp').value,
                password: document.getElementById('reg-pass').value,
                role: document.getElementById('reg-role').value
            };
            try {
                const res = await fetch(`${baseUrl}/auth/register`, {
                    method: 'POST',
                    headers: getHeaders(),
                    credentials: 'include', // WAJIB untuk kirim/terima cookie
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-login').onclick = async () => {
            const body = {
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-pass').value
            };
            try {
                const res = await fetch(`${baseUrl}/auth/login`, {
                    method: 'POST',
                    headers: getHeaders(),
                    credentials: 'include', // WAJIB
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                // DIUBAH: Cek data.user, bukan data.token
                if (res.ok && data.user) {
                    userInfoEl.textContent =
                        `User ID: ${data.user.userId}\n` +
                        `Email: ${data.user.email}\n` +
                        `Role: ${data.user.role.toUpperCase()}`;
                    showResponse({ message: "LOGIN BERHASIL. Session cookie diterima.", userInfo: data.user });
                } else {
                    userInfoEl.textContent = "Login gagal.";
                    showResponse(data);
                }
            } catch (e) {
                userInfoEl.textContent = "Error saat login.";
                showResponse({ error: e.message });
            }
        };

        // BARU: Event listener untuk Logout
        document.getElementById('btn-logout').onclick = async () => {
            try {
                const res = await fetch(`${baseUrl}/auth/logout`, {
                    method: 'POST',
                    headers: getHeaders(),
                    credentials: 'include' // WAJIB
                });
                const data = await res.json();
                if (res.ok) {
                    userInfoEl.textContent = "Anda telah logout.";
                }
                showResponse(data);
            } catch (e) { showResponse({ error: e.message }); }
        };

        // --- 2. CUSTOMER: PRODUCTS ---
        document.getElementById('btn-get-products').onclick = async () => {
            try {
                const res = await fetch(`${baseUrl}/products/search`, {
                    method: 'GET',
                    credentials: 'include' // WAJIB
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-get-product-by-id').onclick = async () => {
            const prodId = document.getElementById('prod-id').value;
            if (!prodId) {
                showResponse({ error: "Masukkan ID Produk" });
                return;
            }
            try {
                const res = await fetch(`${baseUrl}/products/search/${prodId}`, {
                    method: 'GET',
                    credentials: 'include' // WAJIB
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        // --- 2. CUSTOMER: CART ---
        document.getElementById('btn-add-cart').onclick = async () => {
            const body = {
                id_produk: parseInt(document.getElementById('cart-prod-id').value, 10),
                qty: parseInt(document.getElementById('cart-qty').value, 10)
            };
            try {
                const res = await fetch(`${baseUrl}/cart/items`, {
                    method: 'POST',
                    headers: getHeaders(),
                    credentials: 'include', // WAJIB
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-cart-update').onclick = async () => {
            const prodId = document.getElementById('cart-prod-id').value;
            const body = {
                qty: parseInt(document.getElementById('cart-qty').value, 10)
            };
            if (!prodId) {
                showResponse({ error: "Masukkan ID Produk di field keranjang" });
                return;
            }
            try {
                const res = await fetch(`${baseUrl}/cart/items/${prodId}`, {
                    method: 'PATCH',
                    headers: getHeaders(),
                    credentials: 'include', // WAJIB
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-cart-delete').onclick = async () => {
            const prodId = document.getElementById('cart-prod-id').value;
            if (!prodId) {
                showResponse({ error: "Masukkan ID Produk di field keranjang" });
                return;
            }
            try {
                const res = await fetch(`${baseUrl}/cart/items/${prodId}`, {
                    method: 'DELETE',
                    headers: getHeaders(),
                    credentials: 'include' // WAJIB
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-get-cart').onclick = async () => {
            try {
                const res = await fetch(`${baseUrl}/cart`, {
                    method: 'GET',
                    headers: getHeaders(),
                    credentials: 'include' // WAJIB
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        // --- 2. CUSTOMER: ORDERS ---
        document.getElementById('btn-checkout').onclick = async () => {
            try {
                const res = await fetch(`${baseUrl}/orders`, {
                    method: 'POST',
                    headers: getHeaders(),
                    credentials: 'include' // WAJIB
                });
                const data = await res.json();
                if (res.ok && data.id_pesanan) {
                    document.getElementById('order-id').value = data.id_pesanan;
                }
                showResponse(data);
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-get-order-detail').onclick = async () => {
            const orderid = document.getElementById('order-id').value;
            if (!orderid) {
                showResponse({ error: 'Silakan masukkan Order ID' });
                return;
            }
            try {
                const res = await fetch(`${baseUrl}/orders/get/${orderid}`, {
                    method: 'GET',
                    headers: getHeaders(),
                    credentials: 'include' // WAJIB
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-add-payment').onclick = async () => {
            const orderId = document.getElementById('order-id').value;
            const method = document.getElementById('pay-method').value;
            if (!orderId) {
                showResponse({ error: 'ID Pesanan harus diisi' });
                return;
            }
            if (!method) {
                showResponse({ error: 'Metode pembayaran harus dipilih' });
                return;
            }
            const body = {
                method: method,
                amount: parseFloat(document.getElementById('pay-amount').value)
            };
            try {
                const res = await fetch(`${baseUrl}/orders/${orderId}/payments`, {
                    method: 'POST',
                    headers: getHeaders(),
                    credentials: 'include', // WAJIB
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        // --- 3. ADMIN ---
        document.getElementById('btn-admin-add-prod').onclick = async () => {
            const body = {
                nama: document.getElementById('admin-prod-nama').value,
                kategori: document.getElementById('admin-prod-kategori').value,
                deskripsi: document.getElementById('admin-prod-desk').value,
                harga: parseFloat(document.getElementById('admin-prod-harga').value),
                stok: parseInt(document.getElementById('admin-prod-stok').value, 10)
            };
            try {
                const res = await fetch(`${baseUrl}/products`, {
                    method: 'POST',
                    headers: getHeaders(),
                    credentials: 'include', // WAJIB
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-admin-update-prod').onclick = async () => {
            const prodId = document.getElementById('admin-prod-id').value;
            if (!prodId) {
                showResponse({ error: "Masukkan ID Produk di panel Admin" });
                return;
            }
            const body = {};
            const nama = document.getElementById('admin-prod-nama').value;
            const deskripsi = document.getElementById('admin-prod-desk').value;
            const harga = document.getElementById('admin-prod-harga').value;
            const stok = document.getElementById('admin-prod-stok').value;
            if (nama) body.nama = nama;
            if (deskripsi) body.deskripsi = deskripsi;
            if (harga) body.harga = parseFloat(harga);
            if (stok) body.stok = parseInt(stok, 10);
            try {
                const res = await fetch(`${baseUrl}/products/${prodId}`, {
                    method: 'PATCH',
                    headers: getHeaders(),
                    credentials: 'include', // WAJIB
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-admin-delete-prod').onclick = async () => {
            const prodId = document.getElementById('admin-prod-id').value;
            if (!prodId) {
                showResponse({ error: "Masukkan ID Produk di panel Admin" });
                return;
            }
            try {
                const res = await fetch(`${baseUrl}/products/${prodId}`, {
                    method: 'DELETE',
                    headers: getHeaders(),
                    credentials: 'include' // WAJIB
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        // --- 3. USER ---
        document.getElementById('btn-user-get-all').onclick = async () => {
            try {
                const res = await fetch(`${baseUrl}/users`, {
                    method: 'GET',
                    headers: getHeaders(),
                    credentials: 'include' // WAJIB
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-user-get').onclick = async () => {
            const userId = document.getElementById('user-id').value;
            if (!userId) {
                showResponse({ error: "Masukkan User ID" });
                return;
            }
            try {
                const res = await fetch(`${baseUrl}/users/${userId}`, {
                    method: 'GET',
                    headers: getHeaders(),
                    credentials: 'include' // WAJIB
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

        document.getElementById('btn-user-update').onclick = async () => {
            const userId = document.getElementById('user-id').value;
            if (!userId) {
                showResponse({ error: "Masukkan User ID" });
                return;
            }
            const body = {};
            const nama = document.getElementById('user-nama').value;
            const email = document.getElementById('user-email').value;
            if (nama) body.nama = nama;
            if (email) body.email = email;

            try {
                const res = await fetch(`${baseUrl}/users/update/${userId}`, {
                    method: 'PATCH',
                    headers: getHeaders(),
                    credentials: 'include', // WAJIB
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) { showResponse({ error: e.message }); }
        };

    });
</script>
</body>
</html>